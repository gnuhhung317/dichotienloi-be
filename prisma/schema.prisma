generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  USER
  ADMIN
}

enum MemberRole {
  OWNER
  MEMBER
}

enum Scope {
  GLOBAL
  GROUP
}

enum FridgeStatus {
  AVAILABLE
  CONSUMED
  EXPIRED
  DISCARDED
}

enum ExpiryNotificationStatus {
  PENDING
  SENT
  CANCELED
}

enum ShoppingListStatus {
  ACTIVE
  DONE
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
}

enum OwnerType {
  USER
  GROUP
  GLOBAL
}

enum NotificationType {
  EXPIRE_WARNING
  SYSTEM
}

enum FoodLogAction {
  BUY
  CONSUME
  DISCARD
}

enum FridgeAction {
  CONSUMED
  DISCARDED
  EXPIRED
}

// Models
model User {
  id              String            @id @default(uuid())
  email           String            @unique
  password_hash   String            @map("password_hash")
  name            String
  role            Role              @default(USER)
  created_at      DateTime          @default(now()) @map("created_at")

  // Relations
  ownedGroups     Group[]           @relation("GroupOwner")
  memberships     GroupMember[]
  notifications   Notification[]
  shoppingLists   ShoppingList[]    @relation("CreatedBy")
  shoppingItems   ShoppingItem[]    @relation("AssignedTo")
}

model Group {
  id           String          @id @default(uuid())
  name         String
  owner_id     String          @map("owner_id")
  created_at   DateTime        @default(now()) @map("created_at")

  // Relations
  owner        User            @relation("GroupOwner", fields: [owner_id], references: [id])
  members      GroupMember[]
  categories   Category[]
  units        Unit[]
  foods        Food[]
  fridge_items FridgeItem[]
  shopping_lists ShoppingList[]
  meal_plans   MealPlan[]
  food_logs    FoodLog[]
}

model GroupMember {
  id         String     @id @default(uuid())
  group_id   String     @map("group_id")
  user_id    String     @map("user_id")
  role       MemberRole @default(MEMBER)
  joined_at  DateTime   @default(now()) @map("joined_at")

  group      Group      @relation(fields: [group_id], references: [id])
  user       User       @relation(fields: [user_id], references: [id])

  @@unique([group_id, user_id])
}

model Category {
  id       String   @id @default(uuid())
  name     String
  scope    Scope    @default(GLOBAL)
  group_id String?  @map("group_id")

  group    Group?   @relation(fields: [group_id], references: [id])
  foods    Food[]
}

model Unit {
  id       String   @id @default(uuid())
  name     String
  scope    Scope    @default(GLOBAL)
  group_id String?  @map("group_id")

  group    Group?   @relation(fields: [group_id], references: [id])
  foods    Food[]
  fridge_items FridgeItem[]
  recipe_ingredients RecipeIngredient[]
}

model Food {
  id          String      @id @default(uuid())
  name        String
  category_id String      @map("category_id")
  unit_id     String      @map("unit_id")
  group_id    String      @map("group_id")

  category    Category    @relation(fields: [category_id], references: [id])
  unit        Unit        @relation(fields: [unit_id], references: [id])
  group       Group       @relation(fields: [group_id], references: [id])

  fridge_items FridgeItem[]
  shopping_items ShoppingItem[]
  recipe_ingredients RecipeIngredient[]
  food_logs   FoodLog[]
}

model FridgeItem {
  id            String         @id @default(uuid())
  group_id      String         @map("group_id")
  food_id       String         @map("food_id")
  unit_id       String         @map("unit_id")
  quantity      Decimal
  expired_at    DateTime?
  storage_place String?
  status        FridgeStatus   @default(AVAILABLE)
  created_at    DateTime       @default(now()) @map("created_at")
  updated_at    DateTime       @updatedAt @map("updated_at")

  group         Group          @relation(fields: [group_id], references: [id])
  food          Food           @relation(fields: [food_id], references: [id])
  unit          Unit           @relation(fields: [unit_id], references: [id])

  expiry_notifications ExpiryNotification[]
  logs                 FridgeItemLog[]
}

model ExpiryNotification {
  id              String                    @id @default(uuid())
  fridge_item_id  String                    @map("fridge_item_id")
  notify_at       DateTime                  @map("notify_at")
  sent_at         DateTime?
  status          ExpiryNotificationStatus  @default(PENDING)

  fridge_item     FridgeItem @relation(fields: [fridge_item_id], references: [id])
}

model FridgeItemLog {
  id             String      @id @default(uuid())
  fridge_item_id String      @map("fridge_item_id")
  action         FridgeAction
  quantity       Decimal
  created_at     DateTime    @default(now()) @map("created_at")

  fridge_item    FridgeItem  @relation(fields: [fridge_item_id], references: [id])
}

model ShoppingList {
  id         String              @id @default(uuid())
  group_id   String              @map("group_id")
  date       DateTime
  created_by String              @map("created_by")
  status     ShoppingListStatus  @default(ACTIVE)

  group      Group               @relation(fields: [group_id], references: [id])
  createdBy  User                @relation("CreatedBy", fields: [created_by], references: [id])
  items      ShoppingItem[]
}

model ShoppingItem {
  id               String   @id @default(uuid())
  shopping_list_id String   @map("shopping_list_id")
  food_id          String   @map("food_id")
  quantity         Decimal
  assigned_to      String?  @map("assigned_to")
  is_bought        Boolean  @default(false)

  shopping_list    ShoppingList @relation(fields: [shopping_list_id], references: [id])
  food             Food         @relation(fields: [food_id], references: [id])
  assignedTo       User?        @relation("AssignedTo", fields: [assigned_to], references: [id])
}

model MealPlan {
  id        String     @id @default(uuid())
  group_id  String     @map("group_id")
  date      DateTime
  meal_type MealType   @map("meal_type")

  group     Group      @relation(fields: [group_id], references: [id])
  recipes   MealPlanRecipe[]
}

model MealPlanRecipe {
  id             String    @id @default(uuid())
  meal_plan_id   String    @map("meal_plan_id")
  recipe_id      String    @map("recipe_id")

  meal_plan      MealPlan  @relation(fields: [meal_plan_id], references: [id])
  recipe         Recipe    @relation(fields: [recipe_id], references: [id])
}

model Recipe {
  id          String              @id @default(uuid())
  name        String
  description String?
  owner_type  OwnerType
  owner_id    String
  created_at  DateTime            @default(now()) @map("created_at")

  ingredients RecipeIngredient[]
  meal_plans  MealPlanRecipe[]
}

model RecipeIngredient {
  id         String   @id @default(uuid())
  recipe_id  String   @map("recipe_id")
  food_id    String   @map("food_id")
  quantity   Decimal
  unit_id    String   @map("unit_id")

  recipe     Recipe   @relation(fields: [recipe_id], references: [id])
  food       Food     @relation(fields: [food_id], references: [id])
  unit       Unit     @relation(fields: [unit_id], references: [id])
}

model Notification {
  id         String            @id @default(uuid())
  user_id    String            @map("user_id")
  type       NotificationType
  content    String
  is_read    Boolean           @default(false) @map("is_read")
  created_at DateTime          @default(now()) @map("created_at")

  user       User              @relation(fields: [user_id], references: [id])
}

model FoodLog {
  id         String        @id @default(uuid())
  food_id    String        @map("food_id")
  group_id   String        @map("group_id")
  action     FoodLogAction
  quantity   Decimal
  created_at DateTime      @default(now()) @map("created_at")

  food       Food          @relation(fields: [food_id], references: [id])
  group      Group         @relation(fields: [group_id], references: [id])
}